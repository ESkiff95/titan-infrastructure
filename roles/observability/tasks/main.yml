---
- name: Create Configuration Directory
  file:
    path: "{{ deploy_root }}/observability/config"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'

- name: Create Data Directories
  file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: '0755'
  loop:
    - { path: "{{ deploy_root }}/observability/prometheus_data", owner: "1000", group: "1000" }
    - { path: "{{ deploy_root }}/observability/grafana_data", owner: "472", group: "472" }
    - { path: "{{ deploy_root }}/observability/data/gotify", owner: "{{ ansible_user }}", group: "{{ ansible_user }}" }
    - { path: "{{ deploy_root }}/observability/data/uptime-kuma", owner: "{{ ansible_user }}", group: "{{ ansible_user }}" }

# --- CONFIGURATION TASKS (MUST RUN FIRST) ---

- name: Deploy Alertmanager Config
  template:
    src: alertmanager.yml.j2
    dest: "{{ deploy_root }}/observability/config/alertmanager.yml"
    owner: "65534"
    group: "65534"
    mode: '0644'

- name: Deploy Discord Template
  template:
    src: discord.tmpl.j2
    dest: "{{ deploy_root }}/observability/config/discord.tmpl"
    owner: "65534"
    group: "65534"
    mode: '0644'

- name: Deploy Alert Rules
  template:
    src: alerts.yml.j2
    dest: "{{ deploy_root }}/observability/config/alerts.yml"
    owner: "65534"
    group: "65534"
    mode: '0644'
  notify: Restart Monitoring Stack

- name: Deploy Prometheus Config
  template:
    src: prometheus.yml.j2
    dest: "{{ deploy_root }}/observability/config/prometheus.yml"
    owner: "65534"
    group: "65534"
    mode: '0644'
  notify: Restart Monitoring Stack

# --- DEPLOYMENT TASKS (MUST RUN LAST) ---

- name: Deploy Unified Observability Stack
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ observability_root }}/docker-compose.yml"
    mode: '0644'

- name: Ensure Observability Stack is Running
  community.docker.docker_compose_v2:
    project_src: "{{ observability_root }}"
    files:
      - docker-compose.yml
    state: present
    pull: always
    remove_orphans: yes  # This is now SAFE because everything is in one file!

- name: Remove Legacy Signal Stack File
  ansible.builtin.file:
    path: "{{ observability_root }}/signal-stack.yml"
    state: absent
